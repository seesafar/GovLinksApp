<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>OneLink · إدارة الخدمات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- اختياري: ملف نمطك العام -->
  <link rel="stylesheet" href="css/style.css" />

  <style>
    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    .admin-wrapper {
      max-width: 1100px;
      margin: 32px auto;
      padding: 24px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 20px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.9);
    }
    .admin-header { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .admin-title { font-size: 1.6rem; font-weight: 700; color: #38bdf8; }
    .admin-subtitle { font-size: 0.9rem; color: #9ca3af; }

    .admin-key-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 8px; }
    .admin-key-row input {
      padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(148,163,184,.6);
      background: #020617; color: #e5e7eb; min-width: 260px; direction: ltr; text-align: left; font-size: .85rem;
    }
    .admin-key-row button {
      padding: 6px 14px; border-radius: 999px; border: none; cursor: pointer;
      background: #22c55e; color: #022c22; font-size: .85rem; font-weight: 600;
    }
    .admin-key-row button:hover { opacity: .9; }
    .pill {
      font-size: .75rem; padding: 4px 8px; border-radius: 999px;
      background: rgba(15,23,42,.9); border: 1px solid rgba(148,163,184,.4); color: #9ca3af;
    }
    .pill.ok { color:#bbf7d0; border-color: rgba(34,197,94,.5); }
    .pill.bad { color:#fecaca; border-color: rgba(248,113,113,.5); }

    .layout-grid { display: grid; grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr); gap: 16px; margin-top: 18px; }
    .table-box { border-radius: 16px; border: 1px solid rgba(55,65,81,.9); overflow: hidden; background: rgba(15,23,42,.98); }
    table { width: 100%; border-collapse: collapse; font-size: .82rem; }
    thead { background: linear-gradient(to left, #0f172a, #020617); }
    th, td { padding: 7px 8px; text-align: right; border-bottom: 1px solid rgba(31,41,55,.85); vertical-align: middle; }
    th { color:#9ca3af; font-weight: 600; white-space: nowrap; }
    tbody tr:nth-child(even) td { background: rgba(15,23,42,.95); }
    tbody tr:nth-child(odd) td { background: rgba(2,6,23,.98); }
    tbody tr:hover td { background: rgba(8,47,73,.9); }
    .badge-enabled {
      padding: 2px 8px; border-radius: 999px; font-size: .72rem;
      border: 1px solid rgba(34,197,94,.7); color:#bbf7d0; background: rgba(22,163,74,.2);
    }
    .badge-disabled {
      padding: 2px 8px; border-radius: 999px; font-size: .72rem;
      border: 1px solid rgba(248,113,113,.7); color:#fecaca; background: rgba(127,29,29,.35);
    }
    .btn-mini {
      padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(148,163,184,.7);
      background: transparent; color:#e5e7eb; font-size: .75rem; cursor: pointer; margin-inline-start: 4px;
    }
    .btn-mini.toggle { border-color: rgba(34,197,94,.7); }
    .btn-mini.delete { border-color: rgba(248,113,113,.7); }
    .btn-mini:hover { background: rgba(15,23,42,.9); }

    .form-box { border-radius: 16px; border: 1px solid rgba(55,65,81,.9); padding: 14px; background: rgba(2,6,23,.98); }
    .form-box h3 { margin: 0 0 8px; font-size: 1rem; color: #e5e7eb; }
    .form-box p { margin: 0 0 10px; font-size: .8rem; color:#9ca3af; }
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .field label { display:block; font-size:.78rem; color:#9ca3af; margin-bottom:2px; }
    .field input {
      width: 100%; padding: 6px 8px; border-radius: 10px; border: 1px solid rgba(75,85,99,.9);
      background: #020617; color:#e5e7eb; font-size: .8rem; direction: ltr; text-align: left;
    }
    .field input[dir="rtl"] { direction: rtl; text-align: right; }
    .form-actions { display:flex; justify-content:flex-start; gap:8px; margin-top:10px; }
    .btn-primary { padding: 6px 14px; border-radius: 999px; border: none; cursor: pointer; background: #3b82f6; color: #eff6ff; font-size: .85rem; font-weight: 600; }
    .btn-primary:hover { opacity:.9; }
    .hint { font-size: .75rem; color:#6b7280; margin-top: 4px; }

    .upload { display: flex; gap: 8px; align-items: center; margin: 10px 0 4px; }
    .upload input[type="file"] {
      border: 1px solid rgba(75,85,99,.9); padding: 6px; border-radius: 10px; background:#020617; color:#e5e7eb;
    }
    .btn-ghost {
      padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(148,163,184,.6);
      background: transparent; color:#e5e7eb; cursor: pointer; font-size: .82rem;
    }
    .btn-ghost:hover { background: rgba(15,23,42,.9); }

    @media (max-width: 900px) { .layout-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="admin-wrapper">
    <div class="admin-header">
      <div class="admin-title">لوحة إدارة الخدمات · OneLink</div>
      <div class="admin-subtitle">من هنا تقدر تضيف، تعدّل، وتفعّل/تعطّل خدمات المنصات الحكومية في ثواني.</div>

      <!-- شريط الدخول بالجلسة (بدون ?key=) -->
      <div class="admin-key-row" id="authRow">
        <input id="adminKeyInput" type="password" placeholder="أدخل رمز الإدارة (ADMIN_PANEL_KEY)" />
        <button id="connectBtn">اتصال وعرض الخدمات</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none;">تسجيل خروج</button>
        <span id="statusPill" class="pill">غير متصل</span>
      </div>
    </div>

    <div class="layout-grid">
      <!-- الجدول -->
      <div class="table-box">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>المعرف (id)</th>
              <th>الاسم (عربي)</th>
              <th>الفئة</th>
              <th>الحالة</th>
              <th>ترتيب</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="servicesTableBody">
            <tr>
              <td colspan="7" style="text-align:center; padding:14px; color:#9ca3af;">
                أدخل رمز الإدارة واضغط "اتصال" لبدء الجلسة وعرض الخدمات.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- النموذج -->
      <div class="form-box">
        <h3 id="formTitle">إضافة خدمة جديدة</h3>
        <p>يمكنك إضافة منصة أو خدمة جديدة للرابط الموحد مع ربطها بأيقونة ورابط خارجي.</p>

        <form id="addServiceForm">
          <div class="form-grid">
            <div class="field">
              <label for="serviceId">المعرف (id) بالإنجليزي – مثال: <code>absher</code></label>
              <input id="serviceId" name="id" type="text" required />
            </div>
            <div class="field">
              <label for="nameAr">الاسم بالعربي</label>
              <input id="nameAr" name="nameAr" type="text" dir="rtl" required />
            </div>
            <div class="field">
              <label for="nameEn">الاسم بالإنجليزي (اختياري)</label>
              <input id="nameEn" name="nameEn" type="text" />
            </div>
            <div class="field">
              <label for="category">الفئة / الجهة – مثال: وزارة الداخلية</label>
              <input id="category" name="category" type="text" dir="rtl" />
            </div>
            <div class="field">
              <label for="url">الرابط الكامل – مثال: <code>https://www.absher.sa</code></label>
              <input id="url" name="url" type="url" />
            </div>

            <!-- رفع أيقونة + مسارها -->
            <div class="field">
              <label for="icon">مسار الأيقونة (يتعبّأ تلقائي بعد الرفع):</label>
              <input id="icon" name="icon" type="text" placeholder="/icons/..." />
              <div class="upload">
                <input id="iconFile" type="file" accept=".png,.jpg,.jpeg,.svg,.webp" />
                <button type="button" id="btnUploadIcon" class="btn-ghost">رفع الأيقونة</button>
              </div>
              <div class="hint">أقصى حجم 512KB — الأنواع المسموحة: PNG / JPG / SVG / WEBP</div>
            </div>

            <div class="field">
              <label for="order">الترتيب في الواجهة (رقم)</label>
              <input id="order" name="order" type="number" min="1" />
            </div>

            <div class="field">
              <label><input id="enabled" type="checkbox" checked /> مفعّلة</label>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" id="submitBtn" class="btn-primary">إضافة الخدمة</button>
            <button type="button" id="cancelEditBtn" class="btn-mini delete" style="display:none;">إلغاء التعديل</button>
          </div>

          <div class="hint">لازم تكون متصل بجلسة إدارة صحيحة (Login) لحفظ التغييرات.</div>
        </form>
      </div>
    </div>
  </div>

<script>
  // ======== حالة الجلسة والمتغيرات العامة ========
  let CSRF = null;
  let servicesCache = [];
  let currentEditingId = null;
  const $ = (sel) => document.querySelector(sel);

  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function setStatus(text, ok = null) {
    const pill = $("#statusPill");
    if (!pill) return;
    pill.textContent = text;
    pill.classList.remove("ok","bad");
    if (ok === true) pill.classList.add("ok");
    if (ok === false) pill.classList.add("bad");
  }

  // REST helper: يضيف الكوكي + CSRF تلقائي
  async function api(path, opts = {}) {
    const cfg = {
      method: opts.method || "GET",
      credentials: "include",
      headers: Object.assign(
        { },
        opts.headers || {}
      ),
      body: opts.body || undefined
    };
    // إضافة CSRF لطلبات التعديل
    if (["POST","PUT","PATCH","DELETE"].includes(cfg.method)) {
      cfg.headers["x-csrf-token"] = CSRF || "";
      if (!cfg.headers["Content-Type"] && !(cfg.body instanceof FormData)) {
        cfg.headers["Content-Type"] = "application/json";
      }
    } else {
      // GET عادة بدون Content-Type
    }

    const res = await fetch(path, cfg);
    let data = {};
    try { data = await res.json(); } catch(_){}
    if (!res.ok) {
      const msg = data.message || data.status || res.statusText;
      throw new Error(msg);
    }
    return data;
  }

  // ======== Auth: تسجيل الدخول والخروج ========
  async function loginWithPassword(pw) {
    const j = await api("/api/admin/login", {
      method: "POST",
      body: JSON.stringify({ password: pw })
    });
    CSRF = j.csrf || null;
    $("#logoutBtn").style.display = "inline-flex";
    setStatus("متصل", true);
    await fetchServices();
  }

  async function logout() {
    await api("/api/admin/logout", { method: "POST" });
    CSRF = null;
    $("#logoutBtn").style.display = "none";
    setStatus("غير متصل", null);
    renderServicesTable([]);
    setCreateMode();
  }

  // ======== تحميل/عرض الخدمات ========
  async function fetchServices() {
    try {
      const j = await api("/api/admin/services");
      servicesCache = Array.isArray(j.data) ? j.data : [];
      renderServicesTable(servicesCache);
    } catch (e) {
      setStatus("فشل في عرض الخدمات", false);
      throw e;
    }
  }

  function renderServicesTable(list) {
    const tbody = $("#servicesTableBody");
    tbody.innerHTML = "";
    if (!list.length) {
      tbody.innerHTML = `
        <tr><td colspan="7" style="text-align:center; padding:14px; color:#9ca3af;">
          لا توجد خدمات مُضافة حتى الآن.
        </td></tr>`;
      return;
    }

    list.forEach((s, i) => {
      const id = escapeHtml(s.id || "");
      const nameAr = escapeHtml(s.nameAr || "");
      const category = escapeHtml(s.category || "");
      const order = s.order ?? "";
      const enabled = !!s.enabled;
      const badge = enabled
        ? '<span class="badge-enabled">مفعّلة</span>'
        : '<span class="badge-disabled">معطّلة</span>';

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td><code>${id}</code></td>
        <td>${nameAr}</td>
        <td>${category}</td>
        <td>${badge}</td>
        <td>${order}</td>
        <td>
          <button class="btn-mini toggle" data-act="toggle" data-id="${id}">تفعيل / تعطيل</button>
          <button class="btn-mini" data-act="edit" data-id="${id}">تعديل</button>
          <button class="btn-mini delete" data-act="del" data-id="${id}">حذف</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // ======== وضع الإضافة/التعديل ========
  function setCreateMode() {
    currentEditingId = null;
    $("#formTitle").textContent = "إضافة خدمة جديدة";
    $("#submitBtn").textContent = "إضافة الخدمة";
    $("#cancelEditBtn").style.display = "none";
    const f = $("#addServiceForm");
    if (f) f.reset();
    $("#serviceId").disabled = false;
    $("#enabled").checked = true;
  }

  async function startEditService(id) {
    const s = servicesCache.find(x => x.id === id);
    if (!s) return alert("الخدمة غير موجودة.");

    currentEditingId = id;
    $("#formTitle").textContent = "تعديل خدمة";
    $("#submitBtn").textContent = "حفظ التعديلات";
    $("#cancelEditBtn").style.display = "inline-flex";

    $("#serviceId").value = s.id || "";
    $("#nameAr").value = s.nameAr || "";
    $("#nameEn").value = s.nameEn || "";
    $("#category").value = s.category || "";
    $("#url").value = s.url || "";
    $("#icon").value = s.icon || "";
    $("#order").value = s.order ?? "";
    $("#enabled").checked = !!s.enabled;
    $("#serviceId").disabled = true;
  }

  // ======== عمليات CRUD ========
  async function addService(payload) {
    const j = await api("/api/admin/services", {
      method: "POST",
      body: JSON.stringify(payload)
    });
    return j;
  }

  async function saveEdit(id, updates) {
    const j = await api(`/api/admin/services/${encodeURIComponent(id)}`, {
      method: "PUT",
      body: JSON.stringify(updates)
    });
    return j;
  }

  async function toggleService(id) {
    await api(`/api/admin/services/${encodeURIComponent(id)}/toggle`, {
      method: "PATCH"
    });
  }

  async function deleteServiceReq(id) {
    await api(`/api/admin/services/${encodeURIComponent(id)}`, {
      method: "DELETE"
    });
  }

  // ======== رفع الأيقونة ========
  async function uploadIcon(file) {
    const fd = new FormData();
    fd.append("file", file);
    const res = await fetch("/api/admin/upload-icon", {
      method: "POST",
      credentials: "include",
      headers: { "x-csrf-token": CSRF || "" },
      body: fd
    });
    const j = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(j.message || j.status || "UPLOAD_FAILED");
    return j.path; // /icons/xxx.ext
  }

  // ======== أحداث DOM ========
  document.addEventListener("DOMContentLoaded", () => {
    // اتصال (Login)
    $("#connectBtn").addEventListener("click", async () => {
      const pw = $("#adminKeyInput").value.trim();
      if (!pw) return alert("أدخل رمز الإدارة أولاً.");
      try {
        await loginWithPassword(pw);
      } catch (e) {
        setStatus("رمز غير صحيح", false);
        alert("فشل تسجيل الدخول: " + (e.message || "خطأ"));
      }
    });

    // خروج
    $("#logoutBtn").addEventListener("click", async () => {
      try { await logout(); } catch(e) { alert(e.message || "خطأ عند الخروج"); }
    });

    // جدول الإجراءات (تفويض)
    $("#servicesTableBody").addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      try {
        if (act === "toggle") {
          await toggleService(id);
          await fetchServices();
        } else if (act === "del") {
          if (confirm("تأكيد حذف الخدمة؟")) {
            await deleteServiceReq(id);
            if (currentEditingId === id) setCreateMode();
            await fetchServices();
          }
        } else if (act === "edit") {
          await startEditService(id);
        }
      } catch (e) {
        alert("خطأ: " + (e.message || "غير معروف"));
      }
    });

    // إرسال النموذج (إضافة/تعديل)
    $("#addServiceForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!CSRF) return alert("لازم تسجيل الدخول أولًا.");

      const payload = {
        id: $("#serviceId").value.trim(),
        nameAr: $("#nameAr").value.trim(),
        nameEn: $("#nameEn").value.trim(),
        category: $("#category").value.trim(),
        url: $("#url").value.trim(),
        icon: $("#icon").value.trim(),
        order: $("#order").value ? Number($("#order").value) : undefined,
        enabled: $("#enabled").checked
      };
      if (!payload.id || !payload.nameAr || !payload.url) {
        return alert("المعرف والاسم بالعربي والرابط حقول مطلوبة.");
      }

      try {
        if (currentEditingId) {
          await saveEdit(currentEditingId, payload);
          alert("تم حفظ التعديلات.");
        } else {
          await addService(payload);
          alert("تمت الإضافة بنجاح.");
        }
        setCreateMode();
        await fetchServices();
      } catch (e) {
        alert("فشل الحفظ: " + (e.message || "خطأ"));
      }
    });

    // إلغاء التعديل
    $("#cancelEditBtn").addEventListener("click", () => setCreateMode());

    // رفع الأيقونة
    $("#btnUploadIcon").addEventListener("click", async () => {
      if (!CSRF) return alert("لازم تسجيل الدخول أولًا.");
      const file = $("#iconFile").files[0];
      if (!file) return alert("اختر ملف أيقونة أولًا.");
      try {
        const path = await uploadIcon(file);
        $("#icon").value = path; // يحفظ المسار في الحقل
        alert("تم رفع الأيقونة.");
      } catch (e) {
        alert("فشل رفع الأيقونة: " + (e.message || "خطأ"));
      }
    });

    // بداية: وضع إنشاء
    setCreateMode();
  });
</script>
</body>
</html>
